# Nginx configuration file
# Generated by PythonWeb Installer

user {{ user|default('www-data') }};
worker_processes {{ worker_processes|default('auto') }};
pid {{ pid_file|default('/run/nginx.pid') }};
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections {{ worker_connections|default(1024) }};
    {% if multi_accept|default(False) %}
    multi_accept {{ multi_accept }};
    {% endif %}
    {% if use|default(False) %}
    use {{ use }};
    {% endif %}
}

http {
    # Basic Settings
    sendfile {{ sendfile|default('on') }};
    tcp_nopush {{ tcp_nopush|default('on') }};
    tcp_nodelay {{ tcp_nodelay|default('on') }};
    keepalive_timeout {{ keepalive_timeout|default(65) }};
    keepalive_requests {{ keepalive_requests|default(100) }};
    types_hash_max_size {{ types_hash_max_size|default(2048) }};
    server_tokens {{ server_tokens|default('off') }};
    client_max_body_size {{ client_max_body_size|default('10m') }};

    # MIME
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log {{ access_log|default('/var/log/nginx/access.log') }};
    error_log {{ error_log|default('/var/log/nginx/error.log') }};

    # Gzip Settings
    {% if gzip_enabled|default(True) %}
    gzip {{ gzip|default('on') }};
    gzip_vary {{ gzip_vary|default('on') }};
    gzip_proxied {{ gzip_proxied|default('any') }};
    gzip_comp_level {{ gzip_comp_level|default(6) }};
    gzip_buffers {{ gzip_buffers|default('16 8k') }};
    gzip_http_version {{ gzip_http_version|default('1.1') }};
    gzip_min_length {{ gzip_min_length|default(1024) }};
    gzip_types {{ gzip_types|default('text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript') }};
    {% endif %}

    # Rate Limiting
    {% if rate_limiting_enabled|default(False) %}
    limit_req_zone {{ limit_req_zone|default('$binary_remote_addr zone=req_limit:10m rate=10r/s') }};
    limit_req {{ limit_req|default('zone=req_limit burst=20 nodelay') }};
    {% endif %}

    # Connection Limiting
    {% if limit_conn_zone|default(False) %}
    limit_conn_zone {{ limit_conn_zone }};
    limit_conn {{ limit_conn|default('addr 100') }};
    {% endif %}

    # File Cache
    {% if open_file_cache|default(False) %}
    open_file_cache {{ open_file_cache }};
    open_file_cache_valid {{ open_file_cache_valid|default('30s') }};
    open_file_cache_min_uses {{ open_file_cache_min_uses|default(2) }};
    open_file_cache_errors {{ open_file_cache_errors|default('on') }};
    {% endif %}

    # Proxy Cache
    {% if proxy_cache_path|default(False) %}
    proxy_cache_path {{ proxy_cache_path }};
    {% endif %}

    # Virtual Host Configs
    server {
        {% if ssl_enabled|default(False) %}
        listen 443 ssl;
        listen [::]:443 ssl;
        {% else %}
        listen 80;
        listen [::]:80;
        {% endif %}

        server_name {{ server_name|default('localhost') }};

        # SSL Configuration
        {% if ssl_enabled|default(False) %}
        ssl {{ ssl|default('on') }};
        ssl_certificate {{ ssl_certificate }};
        ssl_certificate_key {{ ssl_certificate_key }};
        ssl_protocols {{ ssl_protocols|default('TLSv1.2 TLSv1.3') }};
        ssl_ciphers {{ ssl_ciphers|default('HIGH:!aNULL:!MD5') }};
        ssl_prefer_server_ciphers {{ ssl_prefer_server_ciphers|default('on') }};
        ssl_session_timeout {{ ssl_session_timeout|default('1d') }};
        ssl_session_cache {{ ssl_session_cache|default('shared:SSL:50m') }};
        ssl_session_tickets {{ ssl_session_tickets|default('off') }};
        {% if ssl_stapling|default(True) %}
        ssl_stapling {{ ssl_stapling|default('on') }};
        ssl_stapling_verify {{ ssl_stapling_verify|default('on') }};
        {% endif %}
        {% endif %}

        # Security Headers
        {% if add_header|default(False) %}
        {% for header, value in add_header.items() %}
        add_header {{ header }} "{{ value }}";
        {% endfor %}
        {% endif %}

        # IP Filtering
        {% if allow_deny_rules|default(False) %}
        {% for rule in allow_deny_rules %}
        {{ rule }}
        {% endfor %}
        {% endif %}

        # Basic Authentication
        {% if auth_basic|default(False) %}
        auth_basic {{ auth_basic }};
        auth_basic_user_file {{ auth_basic_user_file }};
        {% endif %}

        # Root directory
        root {{ document_root|default('/var/www/html') }};
        index index.html index.htm;

        # Proxy settings
        location / {
            {% if proxy_pass|default(False) %}
            proxy_pass {{ proxy_pass }};
            {% if proxy_set_header|default(False) %}
            {% for header, value in proxy_set_header.items() %}
            proxy_set_header {{ header }} {{ value }};
            {% endfor %}
            {% endif %}
            proxy_redirect {{ proxy_redirect|default('off') }};
            proxy_connect_timeout {{ proxy_connect_timeout|default(60) }};
            proxy_read_timeout {{ proxy_read_timeout|default(60) }};
            proxy_send_timeout {{ proxy_send_timeout|default(60) }};
            {% if proxy_cache|default(False) %}
            proxy_cache {{ proxy_cache }};
            {% if proxy_cache_valid|default(False) %}
            {% for status, time in proxy_cache_valid.items() %}
            proxy_cache_valid {{ status }} {{ time }};
            {% endfor %}
            {% endif %}
            {% endif %}
            {% else %}
            try_files $uri $uri/ =404;
            {% endif %}
        }

        # Static files
        location /static/ {
            alias {{ static_dir|default('/var/www/html/static/') }};
            expires {{ static_expires|default('30d') }};
            add_header Cache-Control "public, max-age=2592000";
        }

        # Media files
        location /media/ {
            alias {{ media_dir|default('/var/www/html/media/') }};
            expires {{ media_expires|default('30d') }};
            add_header Cache-Control "public, max-age=2592000";
        }

        # Error pages
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root {{ error_pages_dir|default('/usr/share/nginx/html') }};
        }
    }
}