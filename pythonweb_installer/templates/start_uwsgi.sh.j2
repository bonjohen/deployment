#!/bin/bash
# uWSGI startup script
# Generated by PythonWeb Installer

# Set environment variables
export PYTHONPATH="{{ app_dir }}"
export APP_ENV="{{ environment|default('production') }}"

# Create log directory if it doesn't exist
mkdir -p "{{ log_dir }}"

# Activate virtual environment
source "{{ python_path|replace('bin/python', 'bin/activate')|replace('Scripts/python.exe', 'Scripts/activate') }}"

# Start uWSGI
echo "Starting uWSGI server..."
cd "{{ app_dir }}"

{% if config_file|default(False) %}
# Start with config file
{{ uwsgi_path }} --ini "{{ config_file }}"
{% else %}
# Start with command line options
{{ uwsgi_path }} \
    --socket={{ socket|default('0.0.0.0:8000') }} \
    --protocol={{ protocol|default('http') }} \
    --processes={{ processes|default(4) }} \
    --threads={{ threads|default(2) }} \
    --master \
    --vacuum \
    --die-on-term \
    --harakiri={{ harakiri|default(30) }} \
    --max-requests={{ max_requests|default(1000) }} \
    --buffer-size={{ buffer_size|default(32768) }} \
    --pythonpath="{{ app_dir }}" \
    --module={{ app_module }} \
    {% if pidfile|default(False) %}--pidfile="{{ pidfile }}" \{% endif %}
    {% if daemonize|default(False) %}--daemonize="{{ daemonize }}" \{% endif %}
    --logto="{{ log_dir }}/uwsgi.log"
{% endif %}

# Check if uWSGI started successfully
if [ $? -eq 0 ]; then
    echo "uWSGI started successfully."
    exit 0
else
    echo "Failed to start uWSGI."
    exit 1
fi
