#!/bin/bash
# Apache startup script
# Generated by PythonWeb Installer

# Set environment variables
export APP_ENV="{{ environment|default('production') }}"

# Create log directory if it doesn't exist
mkdir -p "{{ log_dir }}"

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

# Check if Apache is installed
if ! command -v apache2 &> /dev/null; then
    echo "Apache is not installed. Please install Apache first."
    exit 1
fi

# Create a symbolic link to the configuration file
if [ -f "{{ config_file }}" ]; then
    ln -sf "{{ config_file }}" /etc/apache2/sites-available/pythonweb.conf
    
    # Enable the site
    if [ -d "/etc/apache2/sites-enabled" ]; then
        a2ensite pythonweb.conf
    fi
else
    echo "Configuration file {{ config_file }} not found."
    exit 1
fi

# Enable required modules
a2enmod wsgi
a2enmod rewrite
a2enmod headers
a2enmod expires
{% if ssl_enabled|default(False) %}
a2enmod ssl
{% endif %}

# Test the configuration
echo "Testing Apache configuration..."
apache2ctl configtest

# Check if the test was successful
if [ $? -eq 0 ]; then
    # Start or reload Apache
    if [ -f "{{ pid_file }}" ]; then
        echo "Reloading Apache..."
        apache2ctl graceful
    else
        echo "Starting Apache..."
        apache2ctl start
    fi
    
    # Check if Apache started successfully
    if [ $? -eq 0 ]; then
        echo "Apache started successfully."
        exit 0
    else
        echo "Failed to start Apache."
        exit 1
    fi
else
    echo "Apache configuration test failed."
    exit 1
fi
